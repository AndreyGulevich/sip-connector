# Тестирование машин состояний

Описание подходов к тестированию машин состояний в sip-connector.

## Табличные тесты для переходов

Для каждой машины состояний создаются табличные тесты, которые проверяют все возможные переходы между состояниями. Тесты покрывают:

- Корректные переходы при валидных событиях
- Недопустимые переходы (должны быть отклонены)
- Автоматические переходы (через `always`)
- Переходы при ошибках и сбоях

Пример структуры табличного теста:

```typescript
describe('ConnectionStateMachine transitions', () => {
  const testCases = [
    {
      from: 'IDLE',
      event: 'START_CONNECT',
      to: 'PREPARING',
      shouldSucceed: true,
    },
    {
      from: 'IDLE',
      event: 'START_DISCONNECT',
      to: 'DISCONNECTING',
      shouldSucceed: false, // Недопустимый переход
    },
    // ... другие тест-кейсы
  ];

  testCases.forEach(({ from, event, to, shouldSucceed }) => {
    it(`should ${shouldSucceed ? 'allow' : 'reject'} transition from ${from} to ${to} on ${event}`, () => {
      // Реализация теста
    });
  });
});
```

## Контрактный тест адаптера событий

Проверяется корректность преобразования событий менеджеров в доменные события машин состояний и соответствие ожидаемым статусам.

Тест проверяет:

- События менеджеров → доменные события → ожидаемые статусы
- Корректность маппинга всех событий
- Обработку синтетических событий (например, при ответе на входящий звонок)

## Smoke-тест фасада sipConnector.session

Проверяется корректность работы агрегатора состояний:

- Подписка на изменения состояний
- Получение снапшотов всех доменов
- Доступ к машинам через `sipConnector.session.machines`
- Очистка подписок через `stop()`
- Корректность работы типобезопасных селекторов

## Покрытие тестами

- **Unit-тесты**: для каждой машины состояний отдельно
- **Integration-тесты**: для взаимодействия машин через агрегатор
- **Contract-тесты**: для проверки соответствия событий и состояний
